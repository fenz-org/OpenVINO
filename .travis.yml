if: |
  commit_message =~ /^Build.*:/

os: linux

dist: xenial

language: shell

git:
  depth: 2

services:
  - docker

env:
  global:
    - DOCKER_ORG=provarepro
    - DOCKER_USER=reprova
    # DOCKER_PASS="..."
    - secure: "VgseYmJG5toIeZ9gIu/J4cRyaOMnWldYTbcLIsJleU8R0H7ZEkPM3b3QrXRLcfBjhgE0LW6q+taZJ271ocDUiAf2eoTPKoNjBpzIxu0gxh4j9mUPXG8lhMJf64ma378oPWGMWfi6GMMvZQ3V5fYuHmUQGycYULVOXp6Rww8f6kFCl8vbWHzeMorZNUvwXhOKmq53WRt/mj9UVjxhc9mvAPn/8mk8vB1p8jbU0FgNs7veaOuMJmrXsKWkTtc8HCZFvqbMdcci02sJGHwc3gYP7Hsas7PiMuR1RxJFbVrNIHb02jgrpOWm7hVDBDDc7LHozYXz6usXLLtzgNT9PjlBxOykiO9vQ39daJnnhr7UlesNlOZrg3zyYsQbKIjqwCjxHSQfpUaACpWBa7IJUgGFJz4JbHsWaQB/lJ5HJZVIvgFJyMY2iWzwkoxSaRM1fKWozi9mqX4EHjC7NnFxzwz3I1YNR0C/92rWzcLbnk9aKKq+moj8+bi0VxYAH4R55O+PBoBfK7G8yzv1h1Uc7RsZ4sbV4+WEjaGj/j0XZSVYhqzsUx9RGn2/9/jpNwsh8924YQB79WxeA6pfjZJkwoLpSU0LwIqSj+qCUsB/GVYnD27DJgkiJKJ7I0Nduxa/WCm5+kdec/hgpsTI5n8QmMCuuGkP3xPXD1zGJRVQqxWYsZw="

jobs:
  include:
    - stage: build docker image
      if: |
        commit_message =~ /^Build docker:*/
      script: |
        SW_NAME=`echo ${TRAVIS_REPO_SLUG##*/} | sed 's/ *$//g'`
        DOCKER_SW_NAME=${SW_NAME,,}
        SW_TAG=${TRAVIS_COMMIT_MESSAGE#*"Build docker:"}
        SW_TAG=`echo ${SW_TAG%%,*} | sed 's/ *$//g'`
        
        IMAGE_NAME="${DOCKER_ORG}/${DOCKER_SW_NAME}:${SW_TAG}"

        docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"

        docker pull ${IMAGE_NAME} || true

        docker build\
          --label "BUILT-BY=Travis"\
          --label "BUILT-FROM=${TRAVIS_REPO_SLUG}"\
          --label "BUILD-LOG=${TRAVIS_BUILD_WEB_URL}"\
          --tag ${IMAGE_NAME}\
          ./${SW_TAG}

        docker images

        docker push ${IMAGE_NAME}

